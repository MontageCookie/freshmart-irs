# 系统架构骨架（冻结版）

> 项目：基于 Spring Boot + Vue + 时间序列分析的生鲜销售系统及智能补货系统  
> 目标：以“可闭环业务流程”为颗粒度冻结模块边界与数据流，支撑后续数据模型骨架（Step 1.3）

---

## 1) 模块清单（名称 / 责任边界 / 关联角色 / 输入输出）

### A. Frontend（Vue 3 + Vite + TypeScript）

#### A1. 管理端 Web（Admin Console）
- 名称：管理端 Web（运营后台）
- 责任边界：
  - 面向系统管理员/店长/库管/收银的统一工作台
  - 覆盖账号与权限管理、进销存操作、预警处理、补货审批、数据看板
  - 仅承载交互与展示，不承载业务规则与数据一致性约束
- 关联角色：系统管理员、店长、库管、收银
- 输入输出：
  - 输入：用户操作（登录/查询/审批/录入）、后端返回的业务数据与校验错误
  - 输出：对后端发起的业务操作请求、用于导出/展示的图表与报表视图

#### A2. 顾客端 Web（Customer Portal）
- 名称：顾客端 Web（商城前台）
- 责任边界：
  - 面向顾客的注册/登录、商品浏览、购物车、下单、模拟支付、订单查询
  - 仅承载交互与展示，不承载交易一致性与库存扣减规则
- 关联角色：顾客
- 输入输出：
  - 输入：顾客操作、后端返回的商品/订单数据、支付结果（模拟）
  - 输出：下单与支付确认请求、订单查询请求

---

### B. Backend（Spring Boot + Mybatis-Plus + Security + JWT）

#### B1. 账号与角色闭环模块（Auth & RBAC）
- 名称：账号与角色闭环
- 责任边界：
  - 账号生命周期（注册/登录/退出/禁用/重置）
  - 角色与权限分配、鉴权与会话（JWT）
  - 为其他模块提供“已认证身份 + 角色授权”的统一入口
- 关联角色：系统管理员、店长、库管、收银、顾客
- 输入输出：
  - 输入：登录凭证/注册信息、访问令牌、权限校验请求
  - 输出：认证结果（令牌/会话状态）、鉴权失败原因、操作审计事件（可观测）

#### B2. 商品与库存闭环模块（Catalog & Inventory）
- 名称：商品与库存闭环
- 责任边界：
  - 商品信息维护（上架/下架/分类/价格等业务视图）
  - 库存可用量管理、库存批次/效期视图管理、库存流水的业务归集
  - 提供“可售库存视图”给顾客购买链路与收银链路使用
- 关联角色：店长、库管、收银、顾客
- 输入输出：
  - 输入：商品维护指令、入库结果、销售扣减结果、库存查询请求
  - 输出：可售商品列表与详情视图、库存变更事件、库存状态快照（用于预警/预测）

#### B3. 入库与采购闭环模块（Procurement & Inbound）
- 名称：入库与采购闭环
- 责任边界：
  - 入库业务流程：到货 → 验收 → 入库登记 → 库存增加 → 形成库存流水
  - 承接“店长已审批的采购/补货指令”，由库管执行采购并落到入库流程
  - 对接库存模块完成库存更新与可追溯记录
- 关联角色：店长、库管
- 输入输出：
  - 输入：采购/补货指令（审批通过）、到货信息、验收结果
  - 输出：入库结果、库存增加事件、异常入库记录（可观测）

#### B4. 销售与收银闭环模块（POS & Sales）
- 名称：销售与收银闭环
- 责任边界：
  - 收银侧销售业务流程：选品 → 结算 → 出单 → 扣减库存 → 形成销售记录与库存流水
  - 支持线下收银场景的快速商品检索与结算
  - 与库存模块协同保证“销售扣减”可被追溯与可观测
- 关联角色：收银、店长
- 输入输出：
  - 输入：收银结算请求、库存校验请求
  - 输出：销售结果（小票/订单视图）、库存扣减事件、失败原因（如库存不足）

#### B5. 顾客购买闭环模块（Customer Order）
- 名称：顾客购买闭环
- 责任边界：
  - 顾客侧业务流程：浏览 → 加入购物车 → 下单 → 模拟支付 → 订单确认 → 扣减库存 → 订单查询
  - “模拟支付”作为订单状态流转的一部分：生成支付记录（模拟）并驱动订单状态变化
  - 与库存模块协同完成订单扣减，保证订单与库存变更可追溯
- 关联角色：顾客、店长（查看）、收银（只读对账视图）
- 输入输出：
  - 输入：购物车/下单请求、支付确认（模拟）、订单查询请求
  - 输出：订单状态变化、支付记录（模拟）、库存扣减事件、失败原因（如库存不足/状态不合法）

#### B6. 预警闭环模块（Alerts）
- 名称：预警闭环
- 责任边界：
  - 安全库存预警：当库存状态触发阈值时生成预警并分配处理人
  - 过期/临期预警：根据库存批次效期生成预警并可追踪处理结果
  - 预警处理流程：生成 → 通知/展示 → 确认 → 处置记录归档
- 关联角色：店长、库管
- 输入输出：
  - 输入：库存状态快照、库存批次效期视图、预警确认/处置操作
  - 输出：预警记录状态变化、处置结果（如报损/促销/退货等业务视图）、可观测的事件流

#### B7. 预测与智能补货闭环模块（Forecast & Replenishment）
- 名称：预测与智能补货闭环
- 责任边界：
  - 预测数据准备：从销售与库存视图中导出标准化输入数据（CSV）
  - 触发算法预测：通过命令行调用本地 Python 脚本，读取 stdout JSON 结果
  - 生成建议采购单：将预测结果转化为“建议采购单（系统生成）”，供店长审批
  - 审批与执行联动：审批通过后交由入库与采购闭环模块执行采购/入库
- 关联角色：店长、库管
- 输入输出：
  - 输入：销售历史聚合视图、当前库存状态快照、补货周期与安全库存配置（业务视图）
  - 输出：预测结果（可追溯）、建议采购单（待审批/已驳回/已通过视图）、算法失败记录（可观测）

#### B8. 数据可视化与驾驶舱闭环模块（Analytics & Dashboard）
- 名称：数据可视化与驾驶舱闭环
- 责任边界：
  - 关键指标汇总：销售、库存周转、损耗、预警统计、补货效果等运营视图
  - 将分散的业务结果汇聚为可视化面板，支撑店长决策与系统管理员审计
  - 不改变业务事实，仅做聚合与呈现
- 关联角色：店长、系统管理员
- 输入输出：
  - 输入：销售/库存/预警/补货结果视图
  - 输出：图表数据集与面板视图、导出报表视图

---

### C. Algorithm（Python 3.12 + scikit-learn + pandas + numpy）

#### C1. 时间序列预测脚本模块（Forecast Script）
- 名称：时间序列预测脚本
- 责任边界：
  - 接收后端导出的销售数据 CSV
  - 进行预测并输出 JSON 到 stdout（成功/失败都输出结构化 JSON）
  - 不直接访问数据库、不直接调用后端网络接口
- 关联角色：无（由后端模块触发）
- 输入输出：
  - 输入：CSV 文件路径（命令行参数）
  - 输出：stdout JSON（包含预测量、建议采购量、可选关键中间量；失败时包含错误信息与退出码约定）

---

## 2) 模块关系图（mermaid flowchart：调用方向与数据流）

```mermaid
flowchart LR
  subgraph FE[Frontend]
    FE_ADMIN[管理端 Web\n(Admin Console)]
    FE_CUST[顾客端 Web\n(Customer Portal)]
  end

  subgraph BE[Backend]
    BE_AUTH[账号与角色闭环\n(Auth & RBAC)]
    BE_INV[商品与库存闭环\n(Catalog & Inventory)]
    BE_INB[入库与采购闭环\n(Procurement & Inbound)]
    BE_POS[销售与收银闭环\n(POS & Sales)]
    BE_ORD[顾客购买闭环\n(Customer Order)]
    BE_ALT[预警闭环\n(Alerts)]
    BE_FC[预测与智能补货闭环\n(Forecast & Replenishment)]
    BE_DASH[数据可视化与驾驶舱\n(Analytics & Dashboard)]
  end

  subgraph ALG[Algorithm]
    PY_FC[Python 时间序列预测脚本\n(Forecast Script)]
  end

  FE_ADMIN -->|登录/权限| BE_AUTH
  FE_CUST -->|注册/登录| BE_AUTH

  FE_ADMIN -->|商品/库存操作| BE_INV
  FE_ADMIN -->|入库登记/采购执行| BE_INB
  FE_ADMIN -->|收银销售操作| BE_POS
  FE_ADMIN -->|预警查看/处置| BE_ALT
  FE_ADMIN -->|补货审批/查看预测| BE_FC
  FE_ADMIN -->|看板查询| BE_DASH

  FE_CUST -->|浏览/下单/模拟支付| BE_ORD
  FE_CUST -->|商品浏览| BE_INV

  BE_POS -->|销售扣减| BE_INV
  BE_ORD -->|订单扣减| BE_INV
  BE_INB -->|入库增加| BE_INV

  BE_INV -->|库存状态快照/批次效期视图| BE_ALT
  BE_INV -->|库存状态快照| BE_FC
  BE_POS -->|销售历史聚合视图| BE_FC
  BE_ORD -->|销售历史聚合视图| BE_FC

  BE_FC -->|审批通过的补货指令| BE_INB

  BE_POS -->|销售结果视图| BE_DASH
  BE_INV -->|库存状态视图| BE_DASH
  BE_ALT -->|预警统计视图| BE_DASH
  BE_FC -->|补货建议/效果视图| BE_DASH

  BE_FC -->|CLI: 输入CSV路径| PY_FC
  PY_FC -->|stdout: JSON 预测结果| BE_FC
```

---

## 3) Python 算法调用点说明（后端命令行调用本地 python 脚本）

### 3.1 触发方模块
- 触发方：Backend 的“预测与智能补货闭环模块（Forecast & Replenishment）”
- 触发时机（业务视图层面）：
  - 店长在管理端发起“生成补货建议”
  - 或按后台任务周期性触发（触发方式在架构层允许，但不改变模块边界）

### 3.2 输入（由后端生成）
- 输入载体：CSV 文件（后端生成并写入本地可访问路径）
- 输入内容范畴（口径冻结到“业务视图”层级）：
  - 销售历史聚合序列（按固定时间粒度）
  - 可选的库存状态快照（用于建议采购量计算的当前库存视图）
- 传递方式：CSV 文件路径作为命令行参数传入 Python 脚本

### 3.3 输出（由 Python stdout 输出，后端解析）
- 输出载体：stdout JSON（后端读取 stdout 并解析）
- 输出 JSON 冻结要求：
  - 成功输出：至少包含“预测量”“建议采购量”
  - 可选输出：关键中间量（例如安全库存、补货周期、当前库存等业务视图量）
  - 失败输出：包含错误信息字段，并配合退出码约定

### 3.4 失败场景与可观测性（日志/返回）
- 脚本执行失败（非 0 退出码）：
  - 后端记录 debug 级日志（包含触发人、输入文件标识、退出码、stdout/stderr 摘要）
  - 后端对前端返回“可定位的失败原因”（不暴露环境敏感信息）
- 输出 JSON 解析失败（stdout 非法或字段缺失）：
  - 后端记录 debug 级日志（包含原始输出摘要与解析异常）
  - 后端返回“预测结果不可用”的明确错误结果
- 超时或资源不足：
  - 后端记录 debug 级日志（超时阈值与执行耗时）
  - 后端返回“预测超时/资源不足”的明确错误结果
- 输入文件不可读/为空：
  - 后端在调用前校验并记录 debug 级日志（文件标识与校验结果）
  - 后端返回“预测输入不可用”的明确错误结果

---

## 4) 冻结声明（冻结什么 / 允许什么）

### 4.1 冻结项（本 Step 冻结，后续不得随意改动）
- 冻结模块边界与职责：
  - Frontend：管理端 Web、顾客端 Web
  - Backend：账号与角色闭环、商品与库存闭环、入库与采购闭环、销售与收银闭环、顾客购买闭环、预警闭环、预测与智能补货闭环、数据可视化与驾驶舱闭环
  - Algorithm：时间序列预测脚本模块
- 冻结关键业务闭环链路（至少 5 类能力闭环）：
  - 角色闭环：账号与角色闭环模块统一鉴权入口
  - 进销存闭环：入库与采购 ↔ 商品与库存 ↔ 销售与收银
  - 顾客购买闭环：顾客端 Web ↔ 顾客购买闭环 ↔ 商品与库存（含“模拟支付”驱动订单状态）
  - 预警闭环：商品与库存 → 预警闭环 → 店长/库管处置
  - 预测补货闭环：销售数据聚合/库存快照 → 预测与智能补货 → 建议采购单 → 店长审批 → 库管执行 → 入库与采购 → 商品与库存
- 冻结 Python 调用方式与 I/O 形态：
  - 后端通过命令行调用本地 Python 脚本
  - 输入：CSV 文件路径（命令行参数）
  - 输出：stdout JSON（结构化成功/失败输出）
- 冻结“支付”策略：
  - 顾客购买闭环采用“模拟支付”，不引入独立支付网关模块

### 4.2 允许项（不破坏冻结项前提下允许演进）
- 允许数据库层扩展：
  - 允许新增表/新增字段/新增索引以支撑已冻结模块与闭环
- 允许模块内部实现细化：
  - 允许在不改变模块职责边界与调用关系的前提下细化内部子组件与实现方式
- 允许指标与报表扩展：
  - 允许在数据可视化与驾驶舱模块中新增汇总指标与图表视图，不改变业务事实来源
