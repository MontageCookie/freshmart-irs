# 模块定义卡（Step B1：账号与角色闭环模块）

## 1) 模块目标
- 账号管理：注册、登录、登出、禁用、（管理员）重置密码/修改用户名
- 角色权限管理：仅基于角色（role）进行授权控制（不引入 permission/role_permission）
- 鉴权：JWT Access Token（仅 Access Token，默认 1h）
- 统一入口：为其它业务模块提供“已认证身份 + 角色授权”的统一校验能力

## 2) 参与角色
- 系统管理员（ADMIN）
- 店长（STORE_MANAGER）
- 库管（WAREHOUSE）
- 收银（CASHIER）
- 顾客（CUSTOMER）

## 3) 业务流程（闭环）
### 3.1 正常流程
1. 顾客注册（默认赋予 CUSTOMER 角色）
2. 用户登录（username/password）→ 获取 JWT Access Token（1h）
3. 管理员分配角色（覆盖式更新 user_role）
4. 受保护接口访问：携带 `Authorization: Bearer <token>`，服务端完成 JWT 校验与角色授权
5. 用户登出：仅前端删除 token（服务端不做黑名单）

### 3.2 用户自助动作（登录后）
- 更新个人信息：用户在“记得密码”的前提下，可更新自己的信息（用户名需唯一校验）
  - 约束：用户只能更新自己的账号信息（`id` 必须等于当前登录用户）
  - 约束：更新时必须提交当前密码进行校验（避免 Token 泄露后被篡改资料）
  - 约束：不可自助修改 `roles/status`

### 3.3 管理动作（管理员侧）
- 禁用账户：将 `user.status=DISABLED`，禁用用户无法登录且不可访问需要认证的接口
- 重置密码：仅管理员可执行，复用 `PATCH /api/v1/users/{id}`
- 修改用户名：管理员可执行；用户自助修改用户名需唯一校验且必须校验当前密码

## 4) 输入 / 输出
### 4.1 输入
- 登录凭证：`username/password`
- 注册信息：`username/password`（不允许提交角色）
  - `phone`：可选；中国大陆 11 位手机号
  - `email`：可选；需满足邮箱格式
- 访问令牌：`Authorization: Bearer <JWT>`
- 权限校验请求：访问受保护 API（基于角色授权）
 - 自助更新信息：提交更新字段 + `currentPassword`（用于校验）

### 4.2 输出
- 认证结果：JWT Access Token、过期时间（秒）
- 会话状态：`/auth/me` 返回当前用户信息；`/auth/permissions` 返回 `roles[]`
- 鉴权失败原因：统一响应体 `{code,message,data,traceId}`（如 40100/40300）
- 审计事件：注册、登录、登出、禁用、重置密码、分配角色、更新账户信息（落库，含 traceId）

## 5) 异常分支（最小集合）
- 注册失败：用户名重复、参数非法
- 注册失败（扩展）：手机号/邮箱格式不正确
- 登录失败：用户不存在、密码错误、用户被禁用
- 无权限：角色不匹配（40300）
- 令牌失效：缺失/过期/签名无效（40100）

## 6) 数据落库点（冻结）
- 用户表：`user`
- 角色表：`role`
- 用户角色表：`user_role`
- 审计事件表：新增 1 张最小化审计表（update_v1 追加）

## 7) API 契约（冻结范围）
- `POST /api/v1/auth/login`
- `POST /api/v1/auth/register`
- `POST /api/v1/auth/logout`
- `GET /api/v1/auth/me`
- `GET /api/v1/auth/permissions`（仅返回 `roles[]`）
- `PUT /api/v1/users/{id}/roles`（管理员覆盖式分配角色）
- `PATCH /api/v1/users/{id}`（复用）
  - 用户自助更新：仅允许更新自己的账号信息；必须提交 `currentPassword`；`username` 做唯一校验；不可自助修改 `roles/status`
  - 管理员更新：可修改用户信息；可重置密码（无需 `currentPassword`）；`username` 做唯一校验
