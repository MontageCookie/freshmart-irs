# 模块定义卡（Step B1：账号与角色闭环模块｜前端开发）

## 0) 范围冻结（只做什么）
实现管理端前端闭环（B1），包含：
1. 登录页（username/password）
2. Token 存储（localStorage）
3. 路由鉴权守卫（未登录自动跳转登录）
4. 受保护页面：
   - `/me`：我的信息 + 自助更新信息/修改密码入口
   - `/users`：用户列表（ADMIN）
   - `/users/new`：创建用户（ADMIN）
   - `/users/:id`：用户详情（ADMIN），含更新信息/重置密码/禁用/分配角色
5. 统一 API Client：
   - 自动加 `Authorization: Bearer <token>`（除 `/auth/login`）
   - 统一响应解析（对齐后端 `ApiResponse`：`{code,message,data,traceId}`）
   - 统一拦截处理（401/403 处理、错误提示）
   - 请求/响应日志：仅开发环境打印，严禁打印密码/token 全量
6. 错误可见：页面内提示/全局提示均可，但不允许只在 console 打印

## 1) 禁止事项（不做什么）
- 不做顾客端 A2
- 不做复杂 UI 组件库集成（尽量轻量，避免工程膨胀）
- 不做权限细粒度系统（只按 roles 做页面级显隐/拦截）
- 不引入 mock server（必须对接真实后端）
- 不新增后端接口、字段、表结构
- 不实现注册页 `/register`（用户创建由 ADMIN 管理端完成）

## 2) 技术选型与目录约定
参考技术架构：`frontend/` 使用：
- Vue 3 + Vite + TypeScript
- Vue Router（路由）
- Axios（HTTP Client）
- UI：原生表单 + 轻量 Toast（本阶段不引入 Element Plus）

为后期可引入 Element Plus 做准备：
- UI 交互逻辑与 API/状态管理分层，避免页面直接耦合具体 UI 组件库
- Toast/提示通过统一入口触发，后续可替换为 Element Plus Message 而不改业务逻辑

## 3) 后端接口契约（冻结，前端必须遵守）
接口来源：`docs/project_docs/phase4_模块开发流程/step1_账号与角色模块/后端模块开发/模块定义文档.md`

### 3.1 统一响应体
后端所有接口响应包裹为：
- 成功：`{ code: 0, message: "OK", data: T, traceId: string }`
- 失败：`{ code: 非0, message: string, data: null, traceId: string }`

前端统一解析：
- `code === 0` 视为成功，返回 `data`
- `code !== 0` 视为失败，抛出统一错误对象（包含 `code/message/traceId`），用于 UI 提示

### 3.2 本模块前端需要对接的接口
- 登录：`POST /api/v1/auth/login`
- 我的信息：`GET /api/v1/auth/me`
- 登出：`POST /api/v1/auth/logout`
  - 重要：后端不做 Token 黑名单；前端登出需要主动清理本地 token 并跳转登录页
- 权限列表（可选）：`GET /api/v1/auth/permissions`（本次 MVP 不强制依赖，优先从 `/me` 的 `roles[]` 驱动页面显隐）
- 用户列表（ADMIN）：`GET /api/v1/users`
- 用户创建（ADMIN）：`POST /api/v1/users`
- 用户详情（ADMIN）：`GET /api/v1/users/{id}`
- 用户更新（自助/ADMIN 复用）：`PATCH /api/v1/users/{id}`
- 用户禁用（ADMIN）：`DELETE /api/v1/users/{id}`（语义固定：禁用）
- 角色列表（ADMIN）：`GET /api/v1/roles`
- 分配角色（ADMIN）：`PUT /api/v1/users/{id}/roles`（覆盖式）

## 4) 页面与路由（必须交付）
### 4.1 路由定义
- `/login`
  - 登录页（匿名可访问）
  - 登录成功后：
    - 写入 localStorage token
    - 若存在 `redirect` 查询参数则跳回，否则跳转 `/me`
- `/me`
  - 受保护页（requiresAuth）
  - 调用 `GET /api/v1/auth/me` 展示当前用户信息（含 roles）
- `/users`（ADMIN）
  - 受保护页（requiresAuth + roles=[ADMIN]）
  - 调用 `GET /api/v1/users` 展示用户列表
  - 仅实现筛选：`keyword + status`；不实现 sort（接口参数可保留）
  - 提供“创建用户”入口跳转到 `/users/new`
- `/users/new`（ADMIN）
  - 创建用户表单：username/password/phone/email/roleIds[]
  - 提交 `POST /api/v1/users` 成功后跳转详情页 `/users/{id}`
- `/users/:id`（ADMIN）
  - 区块 1：基本信息（username/phone/email），提交 `PATCH /api/v1/users/{id}`
  - 区块 2：重置密码（管理员）：提交 `newPassword`（无需 currentPassword）
  - 区块 3：禁用用户：调用 `DELETE /api/v1/users/{id}`
  - 区块 4：分配角色（合并在详情页内，不单独路由）
    - 先拉取 `GET /api/v1/roles`（仅启用角色）
    - 覆盖式提交 `PUT /api/v1/users/{id}/roles`，roleIds 不可为空

### 4.2 鉴权守卫策略
- 判断“是否登录”：localStorage 存在 token 视为已登录
- 访问受保护路由但未登录：跳转 `/login?redirect=<fullPath>`
- API 请求返回 `40100/40300`（或 HTTP 401/403）时：
  - 清理本地 token
  - 统一提示错误（包含 traceId）
  - 跳转登录页（保留 `redirect`）

### 4.3 自助更新策略（/me）
- 用户自助更新信息复用 `PATCH /api/v1/users/{id}`
- 约束对齐后端：
  - 只能更新自己
  - 更新资料必须提交 `currentPassword`
  - 修改密码必须提交 `currentPassword + newPassword`
  - 不允许自助修改 `roles/status`

## 5) API Client（必须交付）
### 5.1 Base URL 与环境变量
- 默认后端地址：`http://localhost:8080`
- 通过环境变量覆盖：`VITE_API_BASE_URL`
  - 开发：`.env.development`（或 `.env.local`）中配置，例如：
    - `VITE_API_BASE_URL=http://localhost:8080`

### 5.2 鉴权头注入规则
- 对所有 `/api/v1/**` 请求自动加：
  - `Authorization: Bearer <token>`
- 但排除：
  - `POST /api/v1/auth/login`

### 5.3 统一拦截与错误展示
- 统一把后端 `ApiResponse` 的失败转换成“可展示错误”
- 错误展示要求：
  - 不允许使用 `alert()`
  - 本阶段使用自研的极简 Toast/Notice 组件（不引入 Element Plus）
  - 展示信息至少包含：`message` + `traceId`（便于排障）

### 5.4 开发环境日志（必须脱敏）
- 仅在开发环境打印请求/响应日志（`import.meta.env.DEV === true`）
- 严禁打印敏感信息：
  - password：不打印
  - token：不打印全量（最多打印长度或首尾少量字符）

## 6) CORS 与联调前置（必须写清楚）
### 6.1 前端启动命令（npm）
在仓库根目录执行（后续前端工程位于 `frontend/`）：
- 安装依赖：`npm --prefix frontend install`
- 启动开发：`npm --prefix frontend run dev`

### 6.2 最短联调步骤（登录 → /me）
1. 启动后端：`mvn -f backend/pom.xml spring-boot:run`
2. 前端配置 `VITE_API_BASE_URL=http://localhost:8080`
3. 启动前端开发服务器
4. 打开 `/login`，使用种子账号登录（例如 `admin / aaaa1111`）
5. 登录成功自动进入 `/me`，页面可见当前用户信息与 `roles[]`
6. 访问 `/users`：
   - 需要 `roles[]` 含 `ADMIN`
   - 可看到用户列表，支持 `keyword/status` 过滤
7. 进入用户详情 `/users/:id`：
   - 可更新基本信息
   - 可重置密码（管理员）
   - 可禁用用户
   - 可在同页完成覆盖式分配角色
