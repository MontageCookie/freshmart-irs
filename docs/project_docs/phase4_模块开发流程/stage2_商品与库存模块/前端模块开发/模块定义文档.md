## Step-3 前端模块定义文档（Stage2 商品与库存模块 / B2）

### 0. 变更确认（渐进式 UI 升级策略）

- B1（Auth/User/Role）：维持现有原生样式与实现不变
- 从 B2（本模块）开始：引入 Element Plus，用于本模块新增页面的 UI 组件与交互（包含库存 expand 折叠行）

### 1. 范围与目标

#### 1.1 顾客端（/c 前缀）

- 商品列表：`/c/products`（作为顾客端首页内容，匿名可访问）
- 商品详情：`/c/products/:id`（匿名可访问）
- 导航：提供基础“商品/登录/注册/我的”入口；匿名仅可访问商品列表/详情
- 访问控制：仅访问 `/c/me`（以及未来下单等）才要求登录

#### 1.2 管理端（非 /c 前缀）

- 商品管理
  - 商品列表（分页 + 搜索 + 状态筛选）：默认展示 `ON_SALE`，可切换 `OFF_SALE`
  - 商品创建：仅 `STORE_MANAGER`
  - 商品详情/编辑：`sku/name/unit` 只读；`price/safetyStockQty/status` 可编辑（仅 `STORE_MANAGER`）
  - 下架：调用 DELETE 语义固定为“下架”（仅 `STORE_MANAGER`）
- 库存
  - 库存快照：商品汇总列表 + 行展开显示批次明细（expand）
  - 库存流水：分页列表 + 条件筛选

#### 1.3 不在本模块范围（延后）

- 入库单、预警、销售单、顾客下单/支付

### 2. 权限与交互口径（冻结）

#### 2.1 CASHIER 权限（最严逻辑）

- 必须彻底禁止 `CASHIER` 登录管理端：
  - 管理端登录页：登录成功后校验角色，若为 `CASHIER` 则立即清会话并提示“无权进入管理后台”
  - 路由守卫：物理拦截所有非 `/c/` 路径，若当前会话角色为 `CASHIER`，强制清会话并跳转至顾客端入口

#### 2.2 鉴权失效跳转（分端跳转）

- `/c/**` 路径发生 401/403：清会话并跳转 `/c/login`（带 `redirect`）
- 非 `/c/**` 路径发生 401/403：清会话并跳转 `/login`（带 `redirect`）

#### 2.3 编辑提交口径（读改写 + 全量提交）

- 编辑页初始化必须先 GET 详情拉取全量数据填充表单
- 提交 PUT 时必须全量发送请求体（包含只读字段的原值），避免后端字段被置空

#### 2.4 商品维护字段口径

- 只读：`sku`、`name`、`unit`（创建后不允许修改）
- 可编辑：`price`、`safetyStockQty`、`status`

#### 2.5 WAREHOUSE UI 表达

- 页面组件复用，但根据角色权限直接隐藏“新增/编辑/下架”等写操作按钮

### 3. 路由定义

#### 3.1 顾客端路由

| Path | Auth | 说明 |
|---|---:|---|
| `/c` | 否 | 重定向至 `/c/products` |
| `/c/products` | 否 | 商品列表（首页） |
| `/c/products/:id` | 否 | 商品详情 |
| `/c/login` | 否 | 顾客登录 |
| `/c/register` | 否 | 顾客注册 |
| `/c/me` | 是 | 顾客个人信息 |

#### 3.2 管理端路由

| Path | Auth | 角色 | 说明 |
|---|---:|---|---|
| `/products` | 是 | STORE_MANAGER/WAREHOUSE/ADMIN | 商品列表（默认 ON_SALE，支持切换 OFF_SALE） |
| `/products/new` | 是 | STORE_MANAGER | 创建商品 |
| `/products/:id` | 是 | STORE_MANAGER/WAREHOUSE/ADMIN | 商品详情/编辑（写操作仅 STORE_MANAGER） |
| `/inventory` | 是 | STORE_MANAGER/WAREHOUSE/ADMIN | 库存快照（expand 展开批次） |
| `/inventory/ledgers` | 是 | STORE_MANAGER/WAREHOUSE/ADMIN | 库存流水 |

### 4. 页面与组件清单（B2 新增）

#### 4.1 顾客端 pages

- `CustomerProductsPage.vue`：商品列表（Element Plus）
- `CustomerProductDetailPage.vue`：商品详情（Element Plus）

#### 4.2 管理端 pages

- `ProductsPage.vue`：商品列表（Element Plus Table + 筛选/分页）
- `ProductCreatePage.vue`：创建商品（Element Plus Form）
- `ProductDetailPage.vue`：详情/编辑（Element Plus Form）
- `InventorySnapshotPage.vue`：库存快照（Element Plus Table expand + 批次嵌套表）
- `InventoryLedgersPage.vue`：库存流水（Element Plus Table + 筛选/分页）

### 5. API 对接（后端契约）

#### 5.1 商品（Products）

- `GET /api/v1/products`：商品列表（分页）
  - 匿名/顾客：仅返回 `ON_SALE`
- `GET /api/v1/products/{id}`：商品详情
  - 匿名/顾客：访问下架商品返回 404
- `POST /api/v1/products`：创建商品（STORE_MANAGER）
- `PUT /api/v1/products/{id}`：更新商品（STORE_MANAGER）
- `DELETE /api/v1/products/{id}`：下架商品（STORE_MANAGER，DELETE 语义固定为下架）

#### 5.2 库存（Inventory）

- `GET /api/v1/inventory/snapshot`：库存快照（STORE_MANAGER/WAREHOUSE）
  - 不传 `productId`：返回商品汇总
  - 传 `productId`：返回该商品批次明细（用于 expand 展开）
- `GET /api/v1/inventory/ledgers`：库存流水（STORE_MANAGER/WAREHOUSE）

### 6. 前端类型口径（TypeScript）

#### 6.1 商品

- `status`：`ON_SALE | OFF_SALE`
- `price`：number（后端 BigDecimal）

#### 6.2 库存

- 批次 `status`：`AVAILABLE | BLOCKED | EXPIRED`
- `receivedAt/eventTime`：ISO-8601 字符串
- `expiryDate`：`YYYY-MM-DD`

### 7. 错误处理与反馈

- 全局：沿用现有 `apiRequest` 的错误 toast 提示
- 页面内：保留 `loading / errorText` 状态，避免仅依赖 toast
- 404：
  - 顾客端：提示“商品不存在或已下架”
  - 管理端：提示“商品不存在”

### 8. 验收清单（UI 路径 + 关键用例）

#### 8.1 顾客端

- 访问 `/c` 自动跳转 `/c/products`，无 token 也能看到列表
- `/c/products` 可按关键字搜索，点击进入 `/c/products/:id`
- `/c/products/:id` 展示 `sku/name/unit/price/availableQty/status`
- 下架商品在顾客端访问应返回 404，并在页面提示不可见
- 访问 `/c/me`（无 token）跳转 `/c/login?redirect=/c/me`
- 顾客端导航：未登录显示“登录/注册”，已登录显示“我的/登出”

#### 8.2 管理端

- 使用 `CASHIER` 登录 `/login`：登录成功后立即清会话并提示“无权进入管理后台”
- 任意非 `/c/**` 路径：若会话角色为 `CASHIER`，路由守卫强制拦截并跳转至顾客端入口
- `/products` 默认展示 `ON_SALE`，可切换至 `OFF_SALE`，分页/搜索正常
- `STORE_MANAGER`：可新增/编辑/下架；`WAREHOUSE`：可查看但写按钮隐藏
- 商品编辑：`sku/name/unit` 只读；提交 PUT 全量发送请求体
- `/inventory`：商品汇总表格可展开行，展开后展示批次明细（按 productId 拉取）
- `/inventory/ledgers`：筛选（productId/batchId/changeType/sourceType/时间范围）与分页正常

#### 8.3 鉴权失效分端跳转

- `/c/**` 页面触发 401/403：清会话并跳 `/c/login`（携带 redirect）
- 管理端页面触发 401/403：清会话并跳 `/login`（携带 redirect）

### 9. 变更说明（实现阶段需遵守）

- B2 引入 Element Plus 仅用于本模块新增页面；B1 页面代码与布局不改动
- 如引入 Element Plus 导致全局样式冲突，优先通过局部样式隔离/覆写解决，不回滚 B1 页面结构
