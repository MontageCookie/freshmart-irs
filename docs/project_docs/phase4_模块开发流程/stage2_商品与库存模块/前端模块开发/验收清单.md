## Stage2 商品与库存模块（B2）前端验收清单

### 0. 验收目标

- 覆盖端到端关键路径：顾客端商品浏览、管理端商品管理、库存快照（展开批次）、库存流水
- 覆盖安全/权限关键点：CASHIER 管理端物理拦截、WAREHOUSE 只读 UI、鉴权失效分端跳转
- 覆盖数据口径关键点：编辑“读改写 + 全量提交”避免后端字段被置空

### 1. 环境准备

#### 1.1 运行后端

- 启动后端服务（默认 `http://localhost:8080`）
- 确认可访问接口（任选其一）：
  - `curl http://localhost:8080/api/v1/products`
  - 打开 Knife4j / Swagger（如工程已暴露）

#### 1.2 运行前端

在 `d:\Code\freshmart-irs\frontend` 执行：

```powershell
npm install
npm run dev
```

- 默认前端：`http://localhost:5173`
- 如后端不是 `http://localhost:8080`，需设置环境变量 `VITE_API_BASE_URL`

#### 1.3 预置账号

- 管理端账号（至少具备以下角色各 1 个）：
  - `STORE_MANAGER`
  - `WAREHOUSE`
  - `CASHIER`
- 顾客端账号：
  - `CUSTOMER`（可选，用于验收 `/c/me`）

### 2. 顾客端（匿名商品浏览）

#### 2.1 顾客端首页路由

- 路径：`GET http://localhost:5173/c`
- 期望：
  - 自动跳转到 `/c/products`
  - 页面可正常渲染（Element Plus 样式正常）

#### 2.2 商品列表（匿名）

- 路径：`GET http://localhost:5173/c/products`
- 操作：
  - 不登录，直接进入列表页
  - 输入关键字后回车或点击“搜索”
  - 点击某行进入详情
- 期望：
  - 列表可加载并展示：`id/sku/name/unit/price/availableQty`
  - 搜索后结果发生变化（若后端有对应数据）
  - 点击行后进入 `/c/products/:id`

#### 2.3 商品详情（匿名）

- 路径：`GET http://localhost:5173/c/products/:id`
- 期望：
  - 详情展示：`id/sku/name/unit/price/availableQty/safetyStockQty/status`
  - “返回列表”回到 `/c/products`

#### 2.4 顾客端下架商品不可见（匿名）

- 前置：用 `STORE_MANAGER` 将某商品下架（见 3.4）
- 操作：
  - 在顾客端直接访问该商品详情 `/c/products/:id`
- 期望：
  - 页面提示加载失败（404），语义等价于“商品不存在或已下架”

### 3. 管理端（商品管理）

#### 3.1 登录页可访问

- 路径：`GET http://localhost:5173/login`
- 期望：
  - 页面仍为 B1 原生样式（未引入 Element Plus 的 UI 重构）

#### 3.2 CASHIER 管理端登录拦截（最严逻辑）

- 操作：
  - 在 `/login` 使用 `CASHIER` 账号登录
- 期望：
  - 登录成功后立即清会话
  - 页面提示：`无权进入管理后台`
  - 再次尝试访问任意非 `/c/**` 路径（如 `/products`）会被路由守卫拦截并跳转到 `/c/products`

#### 3.3 商品列表（默认 ON_SALE + 可切换 OFF_SALE）

- 前置：使用 `STORE_MANAGER` 或 `WAREHOUSE` 登录
- 路径：`GET http://localhost:5173/products`
- 操作：
  - 默认进入列表页
  - 状态选择为 `ON_SALE`（默认）
  - 切换状态为 `OFF_SALE` 并筛选
- 期望：
  - `ON_SALE` 为默认筛选条件
  - 切换为 `OFF_SALE` 后列表展示发生变化（若存在下架商品）
  - 列表展示：`id/sku/name/unit/price/availableQty/status`

#### 3.4 STORE_MANAGER 下架商品（DELETE 语义固定为下架）

- 前置：以 `STORE_MANAGER` 登录进入 `/products`
- 操作：
  - 找到某个 `ON_SALE` 商品，点击“下架”
  - 确认对话框后执行
- 期望：
  - toast 提示“下架成功”
  - 该商品在 `ON_SALE` 列表消失；切换到 `OFF_SALE` 可见

#### 3.5 商品创建（仅 STORE_MANAGER）

- 操作：
  - `STORE_MANAGER` 点击“创建商品”进入 `/products/new`
  - 输入 `sku/name/unit/price/safetyStockQty/status` 提交
- 期望：
  - 创建成功后跳转到 `/products/:id`

- 反向用例（WAREHOUSE）：
  - 以 `WAREHOUSE` 登录进入 `/products`
- 期望：
  - “创建商品”按钮不可用（disabled）
  - 列表不显示“下架”按钮

#### 3.6 商品编辑（读改写 + 全量提交；sku/name/unit 只读）

- 前置：以 `STORE_MANAGER` 进入 `/products/:id`
- 操作：
  - 验证 `sku/name/unit` 为禁用不可编辑
  - 修改 `price/safetyStockQty/status` 任意字段，点击“保存”
- 期望：
  - toast 提示“保存成功”
  - 页面重新加载后字段值保持一致
  - 关键：`sku/name/unit` 不应被置空或变更（读改写 + 全量提交生效）

### 4. 管理端（库存）

#### 4.1 库存快照（汇总 + expand 批次）

- 前置：以 `STORE_MANAGER` 或 `WAREHOUSE` 登录
- 路径：`GET http://localhost:5173/inventory`
- 操作：
  - 输入关键字筛选（商品名或 SKU）
  - 展开任意一行
- 期望：
  - 汇总表展示：`productId/sku/name/unit/status/safetyStockQty/availableQty/totalQty`
  - 展开后加载批次明细表，展示：`batchId/batchNo/expiryDate/qtyInitial/qtyAvailable/status/receivedAt`
  - 若无批次，展示“暂无批次明细”

#### 4.2 库存流水（筛选 + 分页）

- 路径：`GET http://localhost:5173/inventory/ledgers`
- 操作：
  - 使用 `productId/batchId/changeType/sourceType/eventFrom~eventTo` 任一组合筛选
  - 翻页
- 期望：
  - 表格展示：`id/productId/batchId/changeType/changeQty/qtyAfter/sourceType/sourceId/eventTime`
  - 分页可用

### 5. 鉴权失效分端跳转

#### 5.1 顾客端 /c/** 鉴权失效跳转 /c/login

- 操作（任选一种）：
  - 进入 `/c/me`，登录 `CUSTOMER` 后打开 DevTools，将 `localStorage.freshmart_irs_access_token` 改成无效值，然后点击页面任一触发请求的按钮（如“刷新”）
- 期望：
  - 清会话后跳转 `/c/login?redirect=/c/me`

#### 5.2 管理端鉴权失效跳转 /login

- 操作（任选一种）：
  - 进入 `/products`，登录 `STORE_MANAGER` 后将 `localStorage.freshmart_irs_access_token` 改成无效值，然后点击“刷新”
- 期望：
  - 清会话后跳转 `/login?redirect=/products`

### 6. 快速接口自检（可选，用于定位问题）

#### 6.1 商品列表（匿名）

```bash
curl "http://localhost:8080/api/v1/products?page=1&size=10"
```

#### 6.2 商品详情（匿名）

```bash
curl "http://localhost:8080/api/v1/products/1"
```

#### 6.3 库存快照（需 JWT）

```bash
# 将 $TOKEN 替换为管理端登录后的 token
curl -H "Authorization: Bearer $TOKEN" "http://localhost:8080/api/v1/inventory/snapshot?page=1&size=10"
```

### 7. 验收输出（由验收人填写）

- 结论：通过 / 不通过
- 不通过项清单：
  - [ ] 编号：
  - [ ] 现象：
  - [ ] 期望：
  - [ ] 复现步骤：
  - [ ] 相关 traceId（如有）：
