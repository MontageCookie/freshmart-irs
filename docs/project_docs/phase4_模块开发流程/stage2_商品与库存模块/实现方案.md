# Stage2 商品与库存模块（Catalog & Inventory）- Step-0 实施方案

## 0. 目标与范围
**目标**：在不破坏既有数据模型骨架与 API 规范的前提下，落地“商品与库存闭环”的最小可演示能力，并冻结后续模块（入库/订单/预警/补货）依赖的查询口径与枚举表达。

**范围（本模块负责）**
- 商品信息维护：SKU、名称、单位、售价、安全库存阈值、上架/下架
- 库存视图能力：
  - 顾客端：可售数量聚合（满足可售口径）
  - 管理端：商品维度汇总 + 批次明细视图
- 库存流水视图能力：按批次可追溯的流水查询

**范围（本模块不负责）**
- 入库写入（由 Step3 入库与采购模块负责）
- 订单扣减与库存记账（由 Step3/Step4 后续模块负责）
- 预警生成与处置（由预警模块负责）

## 1. 已冻结口径（来自确认的 7 项）
1) 写权限：商品写操作（新增/编辑/下架）仅 `STORE_MANAGER`；`WAREHOUSE` 全模块只读  
2) 商品列表/详情：允许匿名访问  
3) 库存快照口径（P0）：
   - 顾客端：聚合 `inventory_batch.status='AVAILABLE'` 且 `expiry_date > CURRENT_DATE` 的可用数量
   - 管理端：商品维度汇总 + 各批次明细视图
4) API 枚举表达：对外统一字符串枚举（如 `AVAILABLE/BLOCKED/EXPIRED`），数据库字段类型保持兼容  
5) 删除语义：`DELETE /products/{id}` 固定为逻辑下架（`status='OFF_SALE'`），历史引用可查  
6) 成本价：禁止在 `product` 表新增成本价；成本口径来自 `stock_in_item.unit_cost`（按批次）  
7) 收银：彻底关闭 `CASHIER` 登录管理端与任何新页面/新接口访问

## 2. 任务拆解（Step-1 到 Step-4 原子级任务）

### Step-1【契约层】Design Spec
- 数据契约冻结
  - 冻结商品与库存相关字段的“对外展示名/类型/口径”（尤其是 status 枚举的对外字符串）
  - 冻结 `expiry_date > CURRENT_DATE` 的可售判定边界（严格大于，不含当天）
  - 明确成本核算引用路径：批次 -> 入库明细 `unit_cost`（不在本模块写入，但冻结口径）
- API 契约冻结（补齐 v1.1 的“暂定”）
  - Products：列表/详情匿名；写接口仅 `STORE_MANAGER`；DELETE 逻辑下架
  - Inventory：库存快照（管理端/顾客端口径）、批次明细、流水查询；角色收敛为 `STORE_MANAGER/WAREHOUSE`
  - 统一响应码：成功 `code=0`；错误码按规范（40100/40300/40400/50000）
- 逻辑规则冻结（伪代码/口径）
  - 可售数量聚合：仅统计可售批次 + 未过期（严格大于当前日期）
  - 商品下架：仅影响顾客端商品可见性，不影响历史订单/报表引用

### Step-2【实现层】后端开发与单测
- 商品模块
  - 新增/编辑/下架：SKU 唯一校验、price>=0、安全库存阈值>=0、status 只允许 `ON_SALE/OFF_SALE`
  - 匿名可查询：`GET /products`、`GET /products/{id}`
  - 权限：写接口仅 `STORE_MANAGER`
- 库存视图模块
  - 顾客端可售数量：提供商品维度 `availableQty`（按可售口径聚合）
  - 管理端视图：商品维度汇总 + 批次明细列表（分页/过滤）
  - 库存流水：分页/过滤查询（productId/batchId/changeType/sourceType/eventFrom/eventTo）
  - 权限：库存相关接口仅 `STORE_MANAGER/WAREHOUSE`
- 枚举映射（关键技术项）
  - 数据库存储保持兼容（现有字段类型不调整）
  - 对外返回字符串枚举；入参也接受字符串枚举
  - 使用 MyBatis-Plus 枚举映射 + Jackson 序列化策略完成“DB code <-> API name”的双向转换
- 单测与接口可跑
  - Service 层逻辑 100% 覆盖（含异常分支：SKU 冲突、下架不可见等）
  - Knife4j：接口可通过 Mock/示例数据跑通（至少覆盖 Products/Inventory 的主路径）

### Step-3【表现层】前端开发
- 顾客端
  - 商品列表/详情（匿名访问）
  - 列表展示 `availableQty`（可选展示，至少支持不为空的口径验收）
- 管理端（店长/库管）
  - 店长：商品维护（新增/编辑/下架、改价、改安全库存阈值）
  - 店长/库管：库存汇总 + 批次明细、库存流水查询
- 权限与体验
  - 401/403/500 统一提示
  - 不给 `CASHIER` 分配管理端路由入口

### Step-4【闭环层】集成联调
- 最短闭环走通（见第 5 节）
- 校验数据库快照：商品状态变更、库存快照口径计算正确
- 验证角色边界：`STORE_MANAGER` 可写；`WAREHOUSE` 只读；`CASHIER` 无入口且访问被拒绝

## 3. 技术选型（冻结）
- 后端：Spring Boot + MyBatis-Plus + Spring Security（JWT）
- 枚举：MyBatis-Plus 枚举处理器（DB code）+ Jackson 输出字符串枚举（API）
- 文档：Knife4j
- 测试：以现有后端测试框架为准（重点覆盖 Service 层）

## 4. 重难点预警与处理策略
- 枚举口径一致性（P0）
  - 风险：数据库为数值/旧口径，但 API 需输出字符串，容易出现前后端口径不一致
  - 策略：在 Step-1 明确“DB code 与 API name”的映射表，并通过统一序列化/反序列化收敛到单点
- 可售数量口径（P0）
  - 风险：`expiry_date > CURRENT_DATE` 的严格边界易与直觉冲突（当天是否可售）
  - 策略：按确认口径实现，并在验收清单写入边界用例（expiry=today 不计入）
- 成本核算口径（P1）
  - 风险：成本来自入库明细，Step2 尚未实现入库写入，容易导致“毛利分析”误期望
  - 策略：本模块只冻结“查询口径与依赖字段”，毛利分析接口/页面推迟到驾驶舱模块实现
- 并发与一致性（P1）
  - 风险：库存扣减并发（订单/入库同时写）不属于 Step2，但未来返工风险高
  - 策略：在 Inventory 领域服务中预留扣减/入库记账能力的接口形态，后续模块统一复用，避免多处实现

## 5. 验收前置：最短业务闭环（可演示最小单元）
- 店长登录管理端
  - 新增商品（含安全库存阈值）-> 上架
  - 修改价格/安全库存阈值 -> 下架
- 顾客端匿名访问
  - 查看商品列表/详情：下架后不可见；上架可见并展示可售数量字段（按口径）
- 管理端库存视图
  - 店长/库管可查询商品维度汇总与批次明细、库存流水（无写入也可查询为空列表）
- 权限验证
  - `WAREHOUSE` 无法执行商品写操作（403）
  - `CASHIER` 无管理端入口且访问新接口被拒绝（401/403）
