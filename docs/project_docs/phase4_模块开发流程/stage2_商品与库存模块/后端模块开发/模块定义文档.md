# 模块定义卡（Stage B2：商品与库存闭环模块）

## 1) 模块目标
- 商品管理（店长）：创建商品、编辑商品、上架/下架、调整售价、调整安全库存阈值
- 库存视图（店长/库管）：商品维度库存汇总、批次明细（效期/可用量/状态）、库存流水（可追溯）
- 顾客端可售口径：提供商品维度可售数量（按可售口径聚合），支撑匿名浏览与下单前展示
- 枚举与口径冻结：对外统一使用字符串枚举，保证前后端与后续模块一致
- 严格语义：`DELETE` 仅用于逻辑下架；不做物理删除

## 2) 参与角色
- 店长（STORE_MANAGER）
- 库管（WAREHOUSE）
- 顾客（CUSTOMER）

> 约束声明（冻结）：
> - 系统管理员（ADMIN）不参与商品与库存业务；仅负责账号与角色管理（Stage1 已实现）。
> - 收银（CASHIER）仅用于历史兼容，不提供任何新页面/新接口访问，且不允许登录管理端。

## 3) 业务流程（闭环）
### 3.1 顾客匿名浏览（商品与可售量）
1. 匿名访问商品列表/详情接口，获取商品基础信息与可售数量（可售口径见第 8 节）
2. 下架商品对顾客端不可见（列表不返回；详情按“资源不可见/不可售”处理）

### 3.2 店长维护商品（写权限仅店长）
1. 店长创建商品：录入 `sku/name/unit/price/safetyStockQty`，默认上架状态按业务规则设置
2. 店长编辑商品：允许修改售价（`price`）、安全库存阈值（`safety_stock_qty`）、上架状态（`status`）
3. 店长下架商品：通过 `DELETE` 触发逻辑下架（`status='OFF_SALE'`）

### 3.3 管理端库存视图（只读）
1. 店长/库管查询库存快照：获得商品维度汇总（可售量/总量/安全库存阈值等）与批次明细（效期/可用量/批次状态）
2. 店长/库管查询库存流水：按商品/批次/变更类型/来源/时间范围过滤并分页返回

### 3.4 与后续模块的协作边界（本模块不写库存）
- 入库与采购模块（Stage3）负责创建入库单并落库库存批次、写入库存流水
- 顾客购买模块（Stage4）负责下单与库存扣减，并写入库存流水
- 本模块只冻结查询口径与状态枚举表达，作为后续模块的“唯一真理来源”

## 4) 输入 / 输出
### 4.1 输入
- 商品写入（店长）：
  - 创建：`sku`、`name`、`unit`、`price`、`safetyStockQty`
  - 编辑：`name`、`unit`、`price`、`safetyStockQty`、`status`
  - 下架：`DELETE` 触发（不接受 body）
- 商品查询（匿名/登录态均可）：
  - 列表：`keyword`、分页参数（`page/size/sort`），可选 `status`
  - 详情：`id`
- 库存查询（店长/库管）：
  - 快照：可选 `productId`/`keyword`、分页参数
  - 流水：`productId`、`batchId`、`changeType`、`sourceType`、`eventFrom`、`eventTo`、分页参数

### 4.2 输出
- 商品视图：`id`、`sku`、`name`、`unit`、`price`、`safetyStockQty`、`status`
- 顾客端可售量：`availableQty`（商品维度聚合字段）
- 库存快照：
  - 商品维度：`productId`、`availableQty`、`totalQty`（可选，口径在设计规格中冻结）、`safetyStockQty`
  - 批次明细：`batchId`、`batchNo`、`qtyAvailable`、`expiryDate`、`status`、`receivedAt`
- 库存流水：`id`、`productId`、`inventoryBatchId`、`changeType`、`changeQty`、`qtyAfter`、`sourceType`、`sourceId`、`eventTime`
- 响应体：统一 `{code,message,data,traceId}`，成功 `code=0`，失败按错误码规范返回

## 5) 异常分支（最小集合）
- 商品创建失败：SKU 重复、参数非法（price<0、safetyStockQty<0、必填缺失）
- 商品更新失败：资源不存在、参数非法、无权限（非 STORE_MANAGER）
- 商品下架失败：资源不存在、无权限
- 顾客端商品详情不可见：商品已下架（对顾客端表现为不可见/不可售）
- 库存查询失败：无权限（非 STORE_MANAGER/WAREHOUSE）、参数非法、资源不存在
- 枚举解析失败：请求入参枚举值不在允许集合内（参数错误）

## 6) 数据落库点（冻结）
- 商品表：`product`
- 库存批次表：`inventory_batch`
- 库存流水表：`inventory_ledger`
- 成本口径依赖（冻结引用，不在本模块写入）：`stock_in_item.unit_cost`（按批次核算口径）

> 数据库约束：不使用外键（逻辑引用即可）。

## 7) API 契约（冻结范围）
- 商品（Products）
  - `GET /api/v1/products`（匿名可访问）
  - `GET /api/v1/products/{id}`（匿名可访问）
  - `POST /api/v1/products`（鉴权：STORE_MANAGER）
  - `PUT /api/v1/products/{id}`（鉴权：STORE_MANAGER）
  - `DELETE /api/v1/products/{id}`（鉴权：STORE_MANAGER；语义固定为逻辑下架）
- 库存视图（Inventory Views）
  - `GET /api/v1/inventory/snapshot`（鉴权：STORE_MANAGER/WAREHOUSE；返回商品维度汇总 + 批次明细）
  - `GET /api/v1/inventory/ledgers`（鉴权：STORE_MANAGER/WAREHOUSE）

## 8) 字符串枚举与口径（冻结）
### 8.1 商品状态（对外）
- `product.status`：`'ON_SALE' | 'OFF_SALE'`
- 逻辑下架：`DELETE /products/{id}` -> `status='OFF_SALE'`

### 8.2 库存批次状态（对外）
- `inventory_batch.status`：`'AVAILABLE' | 'BLOCKED' | 'EXPIRED'`

### 8.3 库存流水变更类型（对外）
- `inventory_ledger.change_type`：`'STOCK_IN' | 'SALE_POS' | 'SALE_ONLINE' | 'ADJUST'`

### 8.4 可售数量口径（顾客端，P0）
- `availableQty(product)` = Σ `inventory_batch.qty_available`
  - 条件 1：`inventory_batch.status = 'AVAILABLE'`
  - 条件 2：`inventory_batch.expiry_date > CURRENT_DATE`

### 8.5 DB 兼容与映射策略（冻结）
- 数据库字段类型保持兼容（沿用现有数值/存储方式），对外统一输出字符串枚举
- 服务端通过 MyBatis-Plus 枚举映射器与 JSON 序列化策略完成双向转换
