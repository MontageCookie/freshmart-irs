# Stage2 · 商品与库存模块（B2）· 后端验收清单（Step-2）

## 0. 验收范围（本次已实现）

### 0.1 商品（Products）
- 匿名可访问商品列表/详情
- 匿名/顾客：仅可见上架（ON_SALE）商品；下架商品视为不存在（404）
- 店长（STORE_MANAGER）：商品创建/更新/下架（DELETE 语义固定为逻辑下架）
- 库管（WAREHOUSE）：全模块只读（可看商品含下架；不可写）
- 商品列表/详情返回 `availableQty`：口径为 `inventory_batch.status=AVAILABLE(1)` 且 `expiry_date > CURRENT_DATE` 的 `qty_available` 聚合

### 0.2 库存（Inventory）
- 管理端库存快照（商品维度汇总 + 可选单商品批次明细）
- 管理端库存流水列表（分页过滤）
- 批次状态对外返回字符串枚举：`AVAILABLE` / `BLOCKED` / `EXPIRED`
- 权限：仅 STORE_MANAGER/WAREHOUSE 可访问

## 1. 环境准备

### 1.1 服务启动（本地）
- 后端默认端口：`http://localhost:8080`
- Knife4j 文档入口：`http://localhost:8080/doc.html`
- OpenAPI：`http://localhost:8080/v3/api-docs`

### 1.2 数据库准备（必须）
1) 创建数据库并初始化表结构：
- 执行：[01_schema_init.sql](file:///d:/Code/freshmart-irs/sql/01_schema_init.sql)
- 执行：[01_schema_update_v1.sql](file:///d:/Code/freshmart-irs/sql/01_schema_update_v1.sql)

2) 初始化种子数据（含账号/角色/示例商品/批次/流水）：
- 执行：[02_data_seed.sql](file:///d:/Code/freshmart-irs/sql/02_data_seed.sql)

### 1.3 测试账号（来自种子数据）
- 统一密码：`aaaa1111`
- admin / manager / warehouse / cashier / customer1

## 2. 通用验收标准（所有接口都需满足）

### 2.1 统一响应体
- 成功：HTTP 2xx，且响应体为 `{ code: 0, message: "OK", data: ..., traceId: ... }`
- 失败：HTTP 状态码与业务码匹配，且响应体为 `{ code: 非0, message: ..., data: null, traceId: ... }`

业务码枚举（供核对）：
- 40001 参数错误
- 40100 未登录或令牌无效
- 40300 无权限
- 40400 资源不存在
- 50000 服务器异常

### 2.2 鉴权头
- 需要登录的接口：`Authorization: Bearer {token}`
- token 获取接口见下文 3.1

## 3. 鉴权与角色验收

### 3.1 获取各角色 token（PowerShell，可直接执行）
建议先在 PowerShell 中执行以下脚本，得到后续验收所需变量（请使用 `curl.exe`）：

```powershell
$Base = "http://localhost:8080"

$TOKEN_MANAGER = (curl.exe -s -X POST "$Base/api/v1/auth/login" -H "Content-Type: application/json" -d '{"username":"manager","password":"aaaa1111"}' | ConvertFrom-Json).data.token
$TOKEN_WAREHOUSE = (curl.exe -s -X POST "$Base/api/v1/auth/login" -H "Content-Type: application/json" -d '{"username":"warehouse","password":"aaaa1111"}' | ConvertFrom-Json).data.token
$TOKEN_CUSTOMER = (curl.exe -s -X POST "$Base/api/v1/auth/login" -H "Content-Type: application/json" -d '{"username":"customer1","password":"aaaa1111"}' | ConvertFrom-Json).data.token
$TOKEN_CASHIER = (curl.exe -s -X POST "$Base/api/v1/auth/login" -H "Content-Type: application/json" -d '{"username":"cashier","password":"aaaa1111"}' | ConvertFrom-Json).data.token

$Products = (curl.exe -s "$Base/api/v1/products?page=1&size=100" | ConvertFrom-Json).data.items
$APPLE_ID = ($Products | Where-Object { $_.sku -eq "APPLE-001" } | Select-Object -First 1 -ExpandProperty id)
$BANANA_ID = ($Products | Where-Object { $_.sku -eq "BANANA-001" } | Select-Object -First 1 -ExpandProperty id)
$MILK_ID = ($Products | Where-Object { $_.sku -eq "MILK-001" } | Select-Object -First 1 -ExpandProperty id)
```

验收点：
- HTTP 200
- `data.tokenType` 为 `Bearer`
- `data.roles` 包含期望角色（manager=STORE_MANAGER，warehouse=WAREHOUSE，customer1=CUSTOMER，cashier=CASHIER）

建议在 Knife4j 中完成登录后，将 token 填入全局 Authorize（Authorization Header）。

### 3.2 未登录访问受保护接口
用例：不带 Authorization 调用库存快照

```powershell
curl.exe -i "$Base/api/v1/inventory/snapshot"
```

验收点：
- HTTP 401
- `code=40100`

### 3.3 无权限访问受保护接口（403）
用例：使用 CUSTOMER token 调用库存快照

验收点：
- HTTP 403
- `code=40300`
- `message` 包含“需要角色 STORE_MANAGER/WAREHOUSE”

## 4. 商品接口验收（/api/v1/products）

### 4.1 匿名商品列表（可用量口径）
```powershell
curl.exe -s "$Base/api/v1/products?page=1&size=10"
```

验收点：
- HTTP 200，`code=0`
- `data.items[*].status` 均为 `ON_SALE`
- `data.items[*].availableQty` 存在且为整数
- 种子数据下，APPLE-001 的 `availableQty` 应为 50（可用批次 qty_available=50 且未过期）

### 4.2 匿名商品详情
```powershell
curl.exe -s "$Base/api/v1/products/$APPLE_ID"
```

验收点：
- HTTP 200，`code=0`
- `data.availableQty` 存在且为整数

### 4.3 店长创建商品（仅 STORE_MANAGER）
```powershell
$ORANGE_ID = (curl.exe -s -X POST "$Base/api/v1/products" -H "Authorization: Bearer $TOKEN_MANAGER" -H "Content-Type: application/json" -d '{"sku":"ORANGE-001","name":"橙子","unit":"kg","price":6.60,"safetyStockQty":5,"status":"ON_SALE"}' | ConvertFrom-Json).data.id
$ORANGE_ID
```

验收点：
- HTTP 200，`data.id > 0`

反例（WAREHOUSE/CASHIER/CUSTOMER）：
- 同请求，换成对应 token，期望 HTTP 403，`code=40300`

### 4.4 店长更新商品（价格/安全库存/状态）
```powershell
curl.exe -s -X PUT "$Base/api/v1/products/$ORANGE_ID" -H "Authorization: Bearer $TOKEN_MANAGER" -H "Content-Type: application/json" -d '{"sku":"ORANGE-001","name":"橙子","unit":"kg","price":7.10,"safetyStockQty":8,"status":"ON_SALE"}'
```

验收点：
- HTTP 200，`data.id=$ORANGE_ID`
- 重新 GET 详情验证字段已更新

参数校验反例：
- `safetyStockQty=-1` 期望 HTTP 400，`code=40001`

### 4.5 DELETE 语义固定为“下架”（逻辑删除）
```powershell
curl.exe -s -X DELETE "$Base/api/v1/products/$ORANGE_ID" -H "Authorization: Bearer $TOKEN_MANAGER"
```

验收点：
- HTTP 200，`data.id=$ORANGE_ID`
- 匿名列表不再包含该商品（或 `total` 变更）
- 匿名 GET `/api/v1/products/$ORANGE_ID` 返回 HTTP 404，`code=40400`
- 使用 WAREHOUSE 或 STORE_MANAGER token GET `/api/v1/products/$ORANGE_ID` 返回 HTTP 200，且 `data.status="OFF_SALE"`

### 4.6 管理端可见性：库管只读且可查看下架
用例：WAREHOUSE token 调用商品列表并过滤 OFF_SALE

验收点：
- HTTP 200，`code=0`
- 允许 `status=OFF_SALE` 并能返回下架商品（如果存在）
- 尝试 POST/PUT/DELETE 均返回 403

## 5. 库存接口验收（/api/v1/inventory）

### 5.1 库存快照（商品维度汇总）
准备：使用 manager 或 warehouse token（记为 `$TOKEN_WAREHOUSE` / `$TOKEN_MANAGER`）

```powershell
curl.exe -s "$Base/api/v1/inventory/snapshot?page=1&size=10" -H "Authorization: Bearer $TOKEN_WAREHOUSE"
```

验收点：
- HTTP 200，`code=0`
- `data.items[*]` 每项包含：
  - `productId/sku/name/unit/price/status/safetyStockQty`
  - `availableQty`（口径：AVAILABLE 且未过期）
  - `totalQty`（口径：该商品所有批次 qty_available 求和，不区分状态/效期）
  - `batches` 为空数组（未指定 productId 时不返回批次明细）

### 5.2 库存快照（指定商品返回批次明细）
```powershell
curl.exe -s "$Base/api/v1/inventory/snapshot?productId=$APPLE_ID" -H "Authorization: Bearer $TOKEN_MANAGER"
```

验收点：
- HTTP 200，`data.page=1`，`data.size=1`，`data.total=1`，`data.items` 仅 1 条
- `data.items[0].batches` 非空（种子数据下 apple 有 1 个批次）
- `batches[*].status` 为字符串枚举（`AVAILABLE/BLOCKED/EXPIRED` 之一）
- `batches[*].receivedAt` 为 ISO-8601（Instant）

### 5.3 库存流水（分页过滤）
```powershell
curl.exe -s "$Base/api/v1/inventory/ledgers?page=1&size=10&productId=$APPLE_ID" -H "Authorization: Bearer $TOKEN_WAREHOUSE"
```

验收点：
- HTTP 200，`code=0`
- 每条包含：`id/productId/batchId/changeType/changeQty/qtyAfter/sourceType/sourceId/eventTime`
- `eventTime` 为 ISO-8601（Instant）

参数校验反例：
- `page=0` 期望 HTTP 400，`code=40001`
- `size=101` 期望 HTTP 400，`code=40001`

## 6. 枚举与口径专项验收（建议执行）

### 6.1 可用量口径：过期批次不计入 availableQty，但计入 totalQty
将某商品批次改为已过期（示例：apple 批次）：
```sql
UPDATE inventory_batch
SET expiry_date = DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY)
WHERE batch_no = 'SEED-BATCH-APPLE-001';
```

验收点：
- 匿名商品列表/详情中 apple 的 `availableQty` 变为 0
- 管理端库存快照中 apple 的 `availableQty` 变为 0，但 `totalQty` 仍为该批次 `qty_available`

恢复数据（可选）：
```sql
UPDATE inventory_batch
SET expiry_date = DATE_ADD(CURRENT_DATE, INTERVAL 10 DAY)
WHERE batch_no = 'SEED-BATCH-APPLE-001';
```

### 6.2 批次状态字符串枚举：BLOCKED/EXPIRED 映射
将某批次置为 BLOCKED（0）：
```sql
UPDATE inventory_batch SET status = 0 WHERE batch_no = 'SEED-BATCH-BANANA-001';
```

验收点：
- `GET /api/v1/inventory/snapshot?productId=$BANANA_ID` 的 `batches[*].status` 出现 `BLOCKED`

将某批次置为 EXPIRED（2）：
```sql
UPDATE inventory_batch SET status = 2 WHERE batch_no = 'SEED-BATCH-MILK-001';
```

验收点：
- `GET /api/v1/inventory/snapshot?productId=$MILK_ID` 的 `batches[*].status` 出现 `EXPIRED`

## 7. UI 路径（Knife4j）
- 打开：`http://localhost:8080/doc.html`
- 操作顺序建议：
  1) Auth -> Login：获取 token
  2) 右上角 Authorize：设置 `Authorization: Bearer {token}`
  3) Products：匿名 list/get；登录后 create/update/delete
  4) Inventory：snapshot/ledgers
