# 模块定义卡（Step A2：账号与角色闭环模块｜前端开发｜顾客端）

## 0) 范围冻结（只做什么）
实现顾客端在“账号与角色模块”上的最小闭环，仅包含：
1. 顾客注册（username/password/phone/email）
2. 顾客登录（username/password）
3. Token 存储（localStorage）
4. 路由鉴权守卫（未登录自动跳转登录）
5. 顾客个人中心：
   - 展示我的信息（username/phone/email/status/roles）
   - 自助更新资料（username/phone/email）与自助修改密码
6. 登出：清理本地 token 并跳转登录页（后端不做 token 黑名单）
7. 统一 API Client（复用现有实现）：
   - 自动加 `Authorization: Bearer <token>`（除 `/auth/login`、`/auth/register`）
   - 统一响应解析（对齐后端 `ApiResponse`：`{code,message,data,traceId}`）
   - 统一拦截处理（401/403 处理、错误提示）

## 1) 禁止事项（不做什么）
- 不做管理端 B1 的用户管理能力（`/users*`、角色分配等）
- 不做商品/购物车/下单等顾客端业务（这些属于后续模块，不在本卡范围）
- 不引入复杂 UI 组件库（保持原生表单 + 轻量提示）
- 不新增后端接口、字段、表结构

## 2) 技术选型与目录约定
在同一个前端工程 `frontend/` 内实现，沿用现有约定：
- Vue 3 + Vite + TypeScript
- Vue Router（路由）
- Axios（HTTP Client）
- UI：原生表单 + 轻量 Toast（不引入 Element Plus）

## 3) 后端接口契约（冻结，前端必须遵守）
接口来源：`docs/project_docs/phase4_模块开发流程/step1_账号与角色模块/后端模块开发/模块定义文档.md`

### 3.1 统一响应体
后端所有接口响应包裹为：
- 成功：`{ code: 0, message: "OK", data: T, traceId: string }`
- 失败：`{ code: 非0, message: string, data: null, traceId: string }`

### 3.2 本模块顾客端需要对接的接口
- 注册：`POST /api/v1/auth/register`
  - 请求体：`{ username, password, phone?, email? }`
  - 成功返回：`{ id }`
- 登录：`POST /api/v1/auth/login`
- 我的信息：`GET /api/v1/auth/me`
- 登出：`POST /api/v1/auth/logout`
- 权限列表（可选）：`GET /api/v1/auth/permissions`
- 自助更新（复用用户更新接口）：`PATCH /api/v1/users/{id}`
  - 任意更新（含资料/密码）均需 `currentPassword`
  - 修改密码需 `currentPassword + newPassword`

## 4) 页面与路由（必须交付）
### 4.1 路由定义（与管理端隔离，避免占用 `/register`）
- `/c/login`
  - 顾客登录页（匿名可访问）
  - 登录成功后：
    - 写入 localStorage token
    - 若存在 `redirect` 查询参数则跳回，否则跳转 `/c/me`
- `/c/register`
  - 顾客注册页（匿名可访问）
  - 注册成功后跳转 `/c/login` 并提示“注册成功，请登录”
- `/c/me`
  - 受保护页（requiresAuth）
  - 调用 `GET /api/v1/auth/me` 展示当前用户信息（含 roles）
  - 在同页提供：
    - 更新资料（username/phone/email + currentPassword）
    - 修改密码（currentPassword + newPassword）
- `/c`
  - 重定向到 `/c/me`

### 4.2 鉴权守卫策略
- 判断“是否登录”：localStorage 存在 token 视为已登录
- 访问受保护路由但未登录：跳转 `/c/login?redirect=<fullPath>`
- 访问匿名路由（`/c/login`、`/c/register`）但已登录：跳转 `/c/me`
- API 请求返回 `40100/40300`（或 HTTP 401/403）时：
  - 清理本地 token
  - 统一提示错误（包含 traceId）
  - 跳转登录页（保留 `redirect`）

### 4.3 表单校验（最小集合）
- 注册：
  - username/password 必填
  - phone/email 允许为空，但填写时必须符合后端校验（手机号 11 位、邮箱格式）
- 自助更新：
  - 任意更新均必填 currentPassword
  - 修改密码时 newPassword 必填

## 5) API Client（复用既有实现）
- 继续使用现有 `apiClient`：
  - `POST /api/v1/auth/register` 与 `POST /api/v1/auth/login` 不带 Authorization
  - 其余请求自动带 Authorization
  - 统一错误对象与 Toast 展示（包含 traceId）

## 6) 执行步骤（线性，不并行）
1. 路由与导航：新增 `/c/*` 路由、匿名/鉴权守卫、顶栏导航在 `/c/*` 场景下指向顾客端入口
2. 注册能力：新增顾客注册页与 `authApi.register()`，完成注册→跳转登录链路
3. 顾客个人中心：复用或抽象现有 `/me` 能力到 `/c/me`（资料更新 + 修改密码，强制 currentPassword）
4. 联调与自测：按验收清单逐条验证，补齐必要的类型与错误展示

## 7) 验收清单（本模块）
1. 未登录访问 `/c/me`：跳转到 `/c/login?redirect=/c/me`
2. 注册成功：提示“注册成功，请登录”，跳转到 `/c/login`
3. 注册失败（用户名重复/参数非法）：页面展示错误 message 与 traceId
4. 登录成功：进入 `/c/me`，可看到 username/roles
5. 登出：清理 token，跳转 `/c/login`
6. 顾客自助更新资料：未填 currentPassword 时前端拦截；填写错误密码时后端返回错误，前端可见 traceId
7. 顾客自助修改密码：成功后仍保持登录态（token 不变），刷新 `/c/me` 信息正常
8. 顾客无法访问管理端页面：访问 `/users` 等页面应被拦截（无入口 + 路由权限控制）
