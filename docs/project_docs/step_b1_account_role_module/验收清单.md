# B1 账号与角色模块【验收清单】

## 0. 验收前置
- 数据库：MySQL 可用；已执行 `sql/01_schema_init.sql`、`sql/01_schema_update_v1.sql`、`sql/02_data_seed.sql`
- 后端启动：`mvn -f backend/pom.xml spring-boot:run`（或已打包 jar 启动）
- 接口文档：可访问 `http://localhost:8080/doc.html`
- 自测命令：`mvn -f backend/pom.xml test package` 可通过

## 1. 统一响应体与错误码
- 任意成功接口响应体为 `{ code:0, message:"OK", data:..., traceId:"..." }`
- 任意失败接口响应体为 `{ code:非0, message:"...", data:null, traceId:"..." }`
- 参数校验/业务校验失败：`code=40001`
- 未登录/令牌无效：`code=40100`
- 无权限：`code=40300`
- 资源不存在：`code=40400`

## 2. 鉴权与权限边界（单层实现）
- 仅存在一层鉴权（Filter），未叠加 Interceptor 等第二层
- 匿名可访问：
  - `POST /api/v1/auth/login`
  - `POST /api/v1/auth/register`
  - `GET /api/v1/products*`
  - OpenAPI 文档相关路径（`/doc.html`、`/swagger-ui*`、`/v3/api-docs*`）
- 需要 ADMIN 才能访问：
  - `GET /api/v1/users`
  - `POST /api/v1/users`
  - `GET /api/v1/users/{id}`
  - `DELETE /api/v1/users/{id}`
  - `PUT /api/v1/users/{id}/roles`
  - `GET /api/v1/roles`

## 3. Auth 模块验收

### 3.1 登录 `POST /api/v1/auth/login`
- 使用种子用户登录成功：
  - 用户：`admin/manager/warehouse/cashier/customer1`
  - 密码：`aaaa1111`
- 成功响应包含字段：
  - `token`、`tokenType=Bearer`、`expiresIn`（秒）、`userId`、`username`、`roles[]`
- 错误场景：
  - 用户名不存在或密码错误：`40100`
  - 用户被禁用（`status=0`）：`40300`

### 3.2 注册 `POST /api/v1/auth/register`
- 请求字段支持：
  - 必填：`username`、`password`
  - 可选：`phone`、`email`
- 密码策略：
  - 至少 8 位，且同时包含字母和数字（不满足返回 `40001`）
- 成功响应返回 `id`
- 默认赋予 `CUSTOMER` 角色（可通过登录后 `roles[]` 验证）

### 3.3 当前用户信息 `GET /api/v1/auth/me`
- 携带合法 JWT 返回：
  - `id`、`username`、`status`、`roles[]`
  - `phone`、`email` 允许为 `null`（不做全量字段回填）
- 数据库即时禁用生效：
  - 将当前用户 `user.status` 置为 `0` 后，再请求 `/auth/me` 应返回 `40300`
- 验证点：每次仅查库校验 `user.status`（不做全量字段查询回填）

### 3.4 权限列表 `GET /api/v1/auth/permissions`
- 返回 `roles[]`
- 验证点：`roles[]` 来自 JWT（不需要每次查 DB）

### 3.5 登出 `POST /api/v1/auth/logout`
- 携带合法 JWT 返回成功（`data=null`）
- 验证点：服务端不维护 token 黑名单（仅记录审计）

## 4. Users & Roles 模块验收

### 4.1 角色列表 `GET /api/v1/roles`（ADMIN）
- 返回仅包含启用角色（`status=1`）的列表
- 包含字段：`id`、`code`、`name`、`enabled=true`

### 4.2 用户列表 `GET /api/v1/users`（ADMIN）
- 分页参数：
  - `page` 从 1 开始；`size` 在 1~100
- 过滤：
  - `keyword`：用户名/手机号模糊
  - `status`：ENABLED/DISABLED
- 返回字段（items）：`id`、`username`、`phone`、`email`、`status`、`createdAt`

### 4.3 创建用户 `POST /api/v1/users`（ADMIN）
- 必填字段：`username`、`password`、`roleIds[]`
- 可选字段：`phone`、`email`
- 校验：
  - 用户名唯一冲突：`40001`
  - 密码策略不通过：`40001`
- 成功后可登录并在 token `roles[]` 中体现分配的角色

### 4.4 用户详情 `GET /api/v1/users/{id}`（ADMIN）
- 用户存在返回：`id`、`username`、`phone`、`email`、`status`、`roles[]`
- 用户不存在返回：`40400`

### 4.5 更新用户 `PATCH /api/v1/users/{id}`（自助/管理员复用）
- 普通用户：
  - 只能修改自己：尝试修改他人返回 `40300`
  - 不允许修改 `status`：传 `status` 返回 `40300`
  - 修改密码必须提供 `currentPassword + newPassword`
    - `currentPassword` 错误返回 `40001`
- 管理员：
  - 可更新任意用户基本信息
  - 可重置密码：只需 `newPassword`，无需 `currentPassword`
- 公共校验：
  - 用户名唯一冲突：`40001`
  - 密码策略不通过：`40001`

### 4.6 禁用用户 `DELETE /api/v1/users/{id}`（ADMIN）
- 语义固定：将用户 `status=0`
- 禁用后该用户登录返回 `40300`；已登录后访问 `/auth/me` 返回 `40300`

### 4.7 分配角色 `PUT /api/v1/users/{id}/roles`（ADMIN）
- 覆盖式分配：以请求 `roleIds[]` 覆盖用户现有角色
- 校验：
  - 角色列表为空：`40001`
  - 存在无效角色 ID：`40001`
  - 包含已禁用角色：`40001`

## 5. 审计落库验收（audit_event）
- 登录成功/失败均写入审计：
  - `event_type=AUTH_LOGIN`，`target_type=USER`
- 注册写入审计：`event_type=USER_REGISTER`
- 用户创建/更新/禁用/分配角色写入审计：
  - `USER_CREATE`、`USER_UPDATE`、`USER_DISABLE`、`ROLE_ASSIGN`
- 登出写入审计：`event_type=AUTH_LOGOUT`
- 字段检查：
  - `trace_id` 非空
  - `actor_user_id`：已登录场景应为当前用户 id；匿名场景可为空
  - `success`：成功为 1，失败为 0；失败时 `reason` 有值

